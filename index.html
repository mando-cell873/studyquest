<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyQuest - å­¦ç¿’å†’é™ºã‚¢ãƒ—ãƒª</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f1a;
    --surface: #141628;
    --card: #1a1e35;
    --border: #252a45;
    --accent: #f0c040;
    --accent2: #e05a8a;
    --accent3: #40c8f0;
    --text: #e8eaf6;
    --text-dim: #7a84b8;
    --xp-color: #5affa0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Starfield background */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 80%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 60%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 50%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 35% 15%, rgba(240,192,64,0.4) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 65% 70%, rgba(64,200,240,0.4) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 480px;
    margin: 0 auto;
    padding: 20px 16px 40px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 24px;
    padding-top: 8px;
  }
  .header h1 {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 0.05em;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header p {
    color: var(--text-dim);
    font-size: 0.8rem;
    margin-top: 4px;
  }

  /* Character Card */
  .character-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }
  .character-card::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 160px; height: 160px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(240,192,64,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  .char-top {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
  }

  .char-avatar {
    width: 96px;
    height: 96px;
    position: relative;
    flex-shrink: 0;
    image-rendering: pixelated;
  }
  .char-avatar svg {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    filter: drop-shadow(0 0 8px rgba(100,200,255,0.5));
    transition: transform 0.3s ease;
  }
  .char-avatar:hover svg { transform: scale(1.08) translateY(-2px); }

  /* Pixel border ring */
  .char-avatar::after {
    content: '';
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 4px;
    border: 2px solid transparent;
    background: linear-gradient(135deg, var(--accent), var(--accent2)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: destination-out;
    mask-composite: exclude;
    animation: spin 4s linear infinite;
    opacity: 0.7;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .char-info { flex: 1; min-width: 0; }
  .char-name {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 2px;
  }
  .char-title {
    font-size: 0.72rem;
    color: var(--accent2);
    background: rgba(224,90,138,0.15);
    border: 1px solid rgba(224,90,138,0.3);
    border-radius: 20px;
    padding: 2px 10px;
    display: inline-block;
    margin-bottom: 8px;
  }
  .char-level {
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .char-level span {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    font-family: 'Zen Maru Gothic', sans-serif;
  }

  /* XP Bar */
  .xp-section { margin-top: 4px; }
  .xp-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.72rem;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .xp-label span:last-child { color: var(--xp-color); }
  .xp-bar-bg {
    height: 8px;
    background: var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .xp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--xp-color), #00e8a0);
    border-radius: 10px;
    transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 0 8px rgba(90,255,160,0.5);
    position: relative;
  }
  .xp-bar-fill::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 12px; height: 100%;
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    animation: shimmer 2s ease-in-out infinite;
  }
  @keyframes shimmer {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 16px;
  }
  .stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px;
    text-align: center;
  }
  .stat-box .stat-icon { font-size: 1.2rem; }
  .stat-box .stat-val {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }
  .stat-box .stat-lbl {
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 2px;
  }

  /* Timer Card */
  .timer-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    margin-bottom: 16px;
    text-align: center;
  }
  .timer-card h2 {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 16px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* Subject selector */
  .subject-select {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .subject-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 0.78rem;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .subject-btn:hover { border-color: var(--accent); color: var(--accent); }
  .subject-btn.active {
    background: rgba(240,192,64,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Timer Display */
  .timer-display {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 4rem;
    font-weight: 900;
    letter-spacing: 0.05em;
    color: var(--text);
    margin-bottom: 4px;
    line-height: 1;
    text-shadow: 0 0 30px rgba(64,200,240,0.3);
    transition: color 0.3s;
  }
  .timer-display.running { color: var(--accent3); }

  .timer-sub {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 20px;
  }

  .timer-controls {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .btn {
    border: none;
    border-radius: 50px;
    padding: 12px 28px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }
  .btn-start {
    background: linear-gradient(135deg, var(--accent), #f0a020);
    color: #0d0f1a;
    box-shadow: 0 4px 20px rgba(240,192,64,0.3);
  }
  .btn-start:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(240,192,64,0.45); }
  .btn-start:active { transform: translateY(0); }

  .btn-stop {
    background: rgba(224,90,138,0.2);
    color: var(--accent2);
    border: 1px solid rgba(224,90,138,0.4);
  }
  .btn-stop:hover { background: rgba(224,90,138,0.3); }

  .btn-reset {
    background: var(--surface);
    color: var(--text-dim);
    border: 1px solid var(--border);
    padding: 12px 18px;
  }
  .btn-reset:hover { color: var(--text); border-color: var(--text-dim); }

  /* Today's Log */
  .log-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .log-card h2 {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.95rem;
    color: var(--text-dim);
    margin-bottom: 14px;
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .log-list { display: flex; flex-direction: column; gap: 8px; }
  .log-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: var(--surface);
    border-radius: 12px;
    border: 1px solid var(--border);
    animation: slideIn 0.4s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }
  .log-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .log-subject { flex: 1; font-size: 0.85rem; }
  .log-time { font-size: 0.8rem; color: var(--text-dim); }
  .log-xp { font-size: 0.75rem; color: var(--xp-color); font-weight: 700; }

  /* Toast notification */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: linear-gradient(135deg, #1a2040, #252a45);
    border: 1px solid var(--accent);
    border-radius: 16px;
    padding: 14px 24px;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.9rem;
    color: var(--accent);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(240,192,64,0.2);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 1000;
    white-space: nowrap;
    text-align: center;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Level up overlay */
  .levelup-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .levelup-overlay.show {
    opacity: 1;
    pointer-events: all;
  }
  .levelup-box {
    text-align: center;
    animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes popIn {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .levelup-box .big-text {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 1rem;
    color: var(--accent2);
    letter-spacing: 0.3em;
    margin-bottom: 8px;
  }
  .levelup-box .level-num {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 6rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    filter: drop-shadow(0 0 20px rgba(240,192,64,0.5));
  }
  .levelup-box .new-title {
    font-size: 1.1rem;
    color: var(--text);
    margin-top: 8px;
    margin-bottom: 24px;
  }
  .levelup-box button {
    background: linear-gradient(135deg, var(--accent), #f0a020);
    color: #0d0f1a;
    border: none;
    border-radius: 50px;
    padding: 12px 32px;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
  }

  /* Confetti particles */
  .particle {
    position: fixed;
    width: 8px;
    height: 8px;
    border-radius: 2px;
    pointer-events: none;
    z-index: 998;
    animation: fall linear forwards;
  }
  @keyframes fall {
    from { transform: translateY(-10px) rotate(0deg); opacity: 1; }
    to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }

  /* Achievements */
  .achievements-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 20px;
  }
  .achievements-card h2 {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.95rem;
    color: var(--text-dim);
    margin-bottom: 14px;
    letter-spacing: 0.08em;
  }
  .ach-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  .ach-item {
    text-align: center;
    padding: 10px 6px;
    background: var(--surface);
    border-radius: 14px;
    border: 1px solid var(--border);
    transition: all 0.3s;
  }
  .ach-item.unlocked {
    border-color: rgba(240,192,64,0.4);
    background: rgba(240,192,64,0.05);
  }
  .ach-item.unlocked:hover { transform: translateY(-2px); }
  .ach-icon { font-size: 1.6rem; filter: grayscale(100%); transition: filter 0.3s; }
  .ach-item.unlocked .ach-icon { filter: none; }
  .ach-name { font-size: 0.6rem; color: var(--text-dim); margin-top: 4px; line-height: 1.3; }
  .ach-item.unlocked .ach-name { color: var(--accent); }

  .empty-log {
    text-align: center;
    color: var(--text-dim);
    font-size: 0.8rem;
    padding: 16px;
  }

  @keyframes floatUp {
    from { opacity: 1; transform: translateX(-50%) translateY(0); }
    to { opacity: 0; transform: translateX(-50%) translateY(-30px); }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>âœ¨ StudyQuest</h1>
    <p>å‹‰å¼·ã—ã¦å†’é™ºè€…ã‚’è‚²ã¦ã‚ˆã†</p>
  </div>

  <!-- Character Card -->
  <div class="character-card">
    <div class="char-top">
      <div class="char-avatar" id="charAvatar">
        <!-- Stage 1: plain clothes + wooden sword (Lv1-3) -->
        <svg class="char-stage" id="charStage1" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges" style="display:block">
          <ellipse cx="48" cy="90" rx="18" ry="3" fill="rgba(0,0,0,0.25)"/>
          <!-- Hair -->
          <rect x="24" y="6" width="48" height="6" fill="#3d2b1a"/>
          <rect x="18" y="12" width="6" height="12" fill="#3d2b1a"/>
          <rect x="72" y="12" width="6" height="12" fill="#3d2b1a"/>
          <rect x="24" y="12" width="12" height="6" fill="#3d2b1a"/>
          <rect x="60" y="12" width="12" height="6" fill="#3d2b1a"/>
          <!-- Head -->
          <rect x="18" y="12" width="60" height="42" fill="#c8a070"/>
          <!-- Eyes -->
          <rect x="30" y="24" width="12" height="12" fill="#fff"/>
          <rect x="54" y="24" width="12" height="12" fill="#fff"/>
          <rect x="36" y="24" width="6" height="12" fill="#1a1a6a"/>
          <rect x="60" y="24" width="6" height="12" fill="#1a1a6a"/>
          <!-- Nose -->
          <rect x="42" y="36" width="12" height="6" fill="#b07850"/>
          <!-- Mouth -->
          <rect x="30" y="42" width="6" height="6" fill="#3d2b1a"/>
          <rect x="36" y="48" width="24" height="6" fill="#3d2b1a"/>
          <rect x="60" y="42" width="6" height="6" fill="#3d2b1a"/>
          <!-- Neck -->
          <rect x="36" y="54" width="24" height="6" fill="#c8a070"/>
          <!-- Body green shirt -->
          <rect x="18" y="60" width="60" height="30" fill="#4a9a40"/>
          <rect x="18" y="60" width="6" height="30" fill="#3a7a30"/>
          <rect x="72" y="60" width="6" height="30" fill="#3a7a30"/>
          <rect x="24" y="72" width="48" height="6" fill="#3a7a30"/>
          <!-- Arms -->
          <rect x="6" y="60" width="12" height="30" fill="#c8a070"/>
          <rect x="6" y="60" width="6" height="30" fill="#b09060"/>
          <rect x="78" y="60" width="12" height="30" fill="#c8a070"/>
          <rect x="84" y="60" width="6" height="30" fill="#b09060"/>
          <!-- Legs -->
          <rect x="18" y="90" width="24" height="24" fill="#3060c0"/>
          <rect x="54" y="90" width="24" height="24" fill="#3060c0"/>
          <rect x="42" y="90" width="12" height="12" fill="#0d0f1a"/>
          <rect x="18" y="90" width="6" height="24" fill="#2050a0"/>
          <rect x="54" y="90" width="6" height="24" fill="#2050a0"/>
          <!-- Boots -->
          <rect x="18" y="114" width="24" height="6" fill="#2a1a0a"/>
          <rect x="54" y="114" width="24" height="6" fill="#2a1a0a"/>
          <!-- Wooden sword -->
          <rect x="84" y="48" width="12" height="6" fill="#c8a060"/>
          <rect x="84" y="54" width="12" height="24" fill="#a07840"/>
          <rect x="78" y="60" width="6" height="6" fill="#c8a060"/>
          <rect x="84" y="78" width="12" height="6" fill="#806030"/>
        </svg>

        <!-- Stage 2: iron armor (Lv4-6) -->
        <svg class="char-stage" id="charStage2" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges" style="display:none">
          <ellipse cx="48" cy="90" rx="18" ry="3" fill="rgba(0,0,0,0.25)"/>
          <!-- Iron helmet -->
          <rect x="18" y="6" width="60" height="12" fill="#a8b8c0"/>
          <rect x="12" y="12" width="6" height="18" fill="#a8b8c0"/>
          <rect x="78" y="12" width="6" height="18" fill="#a8b8c0"/>
          <rect x="18" y="18" width="60" height="6" fill="#8898a0"/>
          <!-- Head -->
          <rect x="18" y="12" width="60" height="42" fill="#c8a070"/>
          <rect x="18" y="12" width="60" height="12" fill="#8898a0"/>
          <!-- Eyes -->
          <rect x="30" y="24" width="12" height="12" fill="#fff"/>
          <rect x="54" y="24" width="12" height="12" fill="#fff"/>
          <rect x="36" y="24" width="6" height="12" fill="#1a3a6a"/>
          <rect x="60" y="24" width="6" height="12" fill="#1a3a6a"/>
          <!-- Mouth -->
          <rect x="30" y="42" width="6" height="6" fill="#3d2b1a"/>
          <rect x="36" y="48" width="24" height="6" fill="#3d2b1a"/>
          <rect x="60" y="42" width="6" height="6" fill="#3d2b1a"/>
          <!-- Neck -->
          <rect x="36" y="54" width="24" height="6" fill="#c8a070"/>
          <!-- Iron chestplate -->
          <rect x="18" y="60" width="60" height="30" fill="#b0c0c8"/>
          <rect x="18" y="60" width="6" height="30" fill="#90a0a8"/>
          <rect x="72" y="60" width="6" height="30" fill="#90a0a8"/>
          <rect x="24" y="60" width="48" height="6" fill="#d0e0e8"/>
          <rect x="30" y="72" width="36" height="12" fill="#90a0a8"/>
          <!-- Iron arms -->
          <rect x="6" y="60" width="12" height="30" fill="#b0c0c8"/>
          <rect x="6" y="60" width="6" height="30" fill="#90a0a8"/>
          <rect x="78" y="60" width="12" height="30" fill="#b0c0c8"/>
          <rect x="84" y="60" width="6" height="30" fill="#90a0a8"/>
          <!-- Iron legs -->
          <rect x="18" y="90" width="24" height="24" fill="#90a0a8"/>
          <rect x="54" y="90" width="24" height="24" fill="#90a0a8"/>
          <rect x="42" y="90" width="12" height="12" fill="#0d0f1a"/>
          <rect x="18" y="90" width="6" height="24" fill="#7090a0"/>
          <rect x="54" y="90" width="6" height="24" fill="#7090a0"/>
          <!-- Iron boots -->
          <rect x="18" y="114" width="24" height="6" fill="#8090a0"/>
          <rect x="54" y="114" width="24" height="6" fill="#8090a0"/>
          <!-- Iron sword -->
          <rect x="84" y="36" width="12" height="6" fill="#c0c0c8"/>
          <rect x="84" y="42" width="12" height="30" fill="#d8d8e0"/>
          <rect x="78" y="48" width="6" height="6" fill="#a0a0a8"/>
          <rect x="84" y="72" width="12" height="6" fill="#806040"/>
        </svg>

        <!-- Stage 3: diamond armor (Lv7-9) -->
        <svg class="char-stage" id="charStage3" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges" style="display:none">
          <ellipse cx="48" cy="90" rx="18" ry="3" fill="rgba(0,0,0,0.3)"/>
          <!-- Diamond helmet -->
          <rect x="12" y="0" width="72" height="18" fill="#40d8e8"/>
          <rect x="6" y="12" width="6" height="18" fill="#40d8e8"/>
          <rect x="84" y="12" width="6" height="18" fill="#40d8e8"/>
          <rect x="12" y="18" width="72" height="6" fill="#20b8c8"/>
          <rect x="42" y="0" width="12" height="12" fill="#a0ffff"/>
          <!-- Head -->
          <rect x="18" y="12" width="60" height="42" fill="#c8a070"/>
          <rect x="18" y="12" width="60" height="12" fill="#20b8c8"/>
          <!-- Glowing eyes -->
          <rect x="30" y="24" width="12" height="12" fill="#fff"/>
          <rect x="54" y="24" width="12" height="12" fill="#fff"/>
          <rect x="36" y="24" width="6" height="12" fill="#00e8ff"/>
          <rect x="60" y="24" width="6" height="12" fill="#00e8ff"/>
          <!-- Stern mouth -->
          <rect x="30" y="42" width="36" height="6" fill="#3d2b1a"/>
          <!-- Neck -->
          <rect x="36" y="54" width="24" height="6" fill="#c8a070"/>
          <!-- Diamond chestplate -->
          <rect x="12" y="60" width="72" height="30" fill="#40d8e8"/>
          <rect x="12" y="60" width="6" height="30" fill="#20b8c8"/>
          <rect x="78" y="60" width="6" height="30" fill="#20b8c8"/>
          <rect x="18" y="60" width="60" height="6" fill="#80f0ff"/>
          <rect x="30" y="72" width="36" height="12" fill="#20b8c8"/>
          <rect x="42" y="66" width="12" height="6" fill="#a0ffff"/>
          <!-- Diamond arms -->
          <rect x="0" y="60" width="12" height="30" fill="#40d8e8"/>
          <rect x="0" y="60" width="6" height="30" fill="#20b8c8"/>
          <rect x="84" y="60" width="12" height="30" fill="#40d8e8"/>
          <rect x="90" y="60" width="6" height="30" fill="#20b8c8"/>
          <!-- Diamond legs -->
          <rect x="12" y="90" width="30" height="24" fill="#30c8d8"/>
          <rect x="54" y="90" width="30" height="24" fill="#30c8d8"/>
          <rect x="42" y="90" width="12" height="12" fill="#0d0f1a"/>
          <rect x="12" y="90" width="6" height="24" fill="#20a8b8"/>
          <rect x="78" y="90" width="6" height="24" fill="#20a8b8"/>
          <!-- Diamond boots -->
          <rect x="12" y="114" width="30" height="6" fill="#40d8e8"/>
          <rect x="54" y="114" width="30" height="6" fill="#40d8e8"/>
          <!-- Enchanted diamond sword -->
          <rect x="84" y="30" width="6" height="6" fill="#a0ffff"/>
          <rect x="84" y="36" width="12" height="42" fill="#60e8ff"/>
          <rect x="78" y="48" width="6" height="6" fill="#a0ffff"/>
          <rect x="84" y="36" width="6" height="42" fill="#c0ffff"/>
          <rect x="84" y="78" width="12" height="6" fill="#5050a0"/>
        </svg>

        <!-- Stage 4: netherite god (Lv10) -->
        <svg class="char-stage" id="charStage4" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges" style="display:none">
          <defs><radialGradient id="ng4" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#c060ff" stop-opacity="0.25"/><stop offset="100%" stop-color="#c060ff" stop-opacity="0"/></radialGradient></defs>
          <rect x="0" y="0" width="96" height="96" fill="url(#ng4)"/>
          <ellipse cx="48" cy="90" rx="20" ry="4" fill="rgba(100,0,200,0.3)"/>
          <!-- Netherite helmet -->
          <rect x="12" y="0" width="72" height="18" fill="#403040"/>
          <rect x="6" y="12" width="6" height="24" fill="#403040"/>
          <rect x="84" y="12" width="6" height="24" fill="#403040"/>
          <rect x="12" y="18" width="72" height="6" fill="#301828"/>
          <rect x="36" y="0" width="24" height="6" fill="#c060ff"/>
          <rect x="42" y="6" width="12" height="6" fill="#e090ff"/>
          <!-- Head -->
          <rect x="18" y="12" width="60" height="42" fill="#c8a070"/>
          <rect x="18" y="12" width="60" height="12" fill="#2a1a28"/>
          <!-- Purple glowing eyes -->
          <rect x="30" y="24" width="12" height="12" fill="#c060ff"/>
          <rect x="54" y="24" width="12" height="12" fill="#c060ff"/>
          <rect x="36" y="24" width="6" height="12" fill="#fff"/>
          <rect x="60" y="24" width="6" height="12" fill="#fff"/>
          <!-- Battle mouth -->
          <rect x="30" y="42" width="12" height="6" fill="#3d2b1a"/>
          <rect x="54" y="42" width="12" height="6" fill="#3d2b1a"/>
          <!-- Neck -->
          <rect x="36" y="54" width="24" height="6" fill="#c8a070"/>
          <!-- Netherite chestplate -->
          <rect x="12" y="60" width="72" height="30" fill="#3a2838"/>
          <rect x="12" y="60" width="6" height="30" fill="#2a1828"/>
          <rect x="78" y="60" width="6" height="30" fill="#5a3858"/>
          <rect x="18" y="60" width="60" height="6" fill="#5a3858"/>
          <rect x="24" y="72" width="48" height="6" fill="#c060ff"/>
          <rect x="30" y="84" width="36" height="6" fill="#c060ff"/>
          <rect x="42" y="66" width="12" height="6" fill="#e090ff"/>
          <!-- Netherite arms -->
          <rect x="0" y="60" width="12" height="30" fill="#3a2838"/>
          <rect x="0" y="60" width="6" height="30" fill="#2a1828"/>
          <rect x="84" y="60" width="12" height="30" fill="#3a2838"/>
          <rect x="90" y="60" width="6" height="30" fill="#5a3858"/>
          <!-- Netherite legs -->
          <rect x="12" y="90" width="30" height="24" fill="#2a1828"/>
          <rect x="54" y="90" width="30" height="24" fill="#2a1828"/>
          <rect x="42" y="90" width="12" height="12" fill="#0d0f1a"/>
          <rect x="18" y="96" width="24" height="12" fill="#c060ff"/>
          <rect x="54" y="96" width="24" height="12" fill="#c060ff"/>
          <!-- Netherite boots with fire -->
          <rect x="12" y="114" width="30" height="6" fill="#3a2838"/>
          <rect x="54" y="114" width="30" height="6" fill="#3a2838"/>
          <rect x="12" y="114" width="30" height="3" fill="#ff8020"/>
          <rect x="54" y="114" width="30" height="3" fill="#ff8020"/>
          <!-- Netherite sword -->
          <rect x="84" y="24" width="12" height="6" fill="#ff8020"/>
          <rect x="84" y="30" width="12" height="48" fill="#3a2838"/>
          <rect x="78" y="42" width="6" height="6" fill="#5a3858"/>
          <rect x="84" y="30" width="6" height="48" fill="#5a3858"/>
          <rect x="84" y="78" width="12" height="6" fill="#8040a0"/>
          <!-- Fire sparks -->
          <rect x="78" y="18" width="6" height="6" fill="#ff8020"/>
          <rect x="72" y="12" width="6" height="6" fill="#ffa040"/>
          <rect x="84" y="12" width="6" height="6" fill="#ff6000"/>
        </svg>
      </div>
      <div class="char-info">
        <div class="char-name" id="charName">ã¾ãªã³ã‚“</div>
        <div class="char-title" id="charTitle">ğŸŒ± è¦‹ç¿’ã„å†’é™ºè€…</div>
        <div class="char-level">ãƒ¬ãƒ™ãƒ« <span id="levelNum">1</span></div>
        <div class="xp-section">
          <div class="xp-label">
            <span>çµŒé¨“å€¤</span>
            <span id="xpText">0 / 60 XP</span>
          </div>
          <div class="xp-bar-bg">
            <div class="xp-bar-fill" id="xpBar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-row" style="grid-template-columns:repeat(2,1fr);">
      <div class="stat-box">
        <div class="stat-icon">ğŸ“š</div>
        <div class="stat-val" id="statTotal">0<span style="font-size:0.6rem">åˆ†</span></div>
        <div class="stat-lbl">ç·å­¦ç¿’æ™‚é–“</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">âš¡</div>
        <div class="stat-val" id="statToday">0<span style="font-size:0.6rem">åˆ†</span></div>
        <div class="stat-lbl">ä»Šæ—¥ã®å­¦ç¿’</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-val" id="statStreak">0<span style="font-size:0.6rem">æ—¥</span></div>
        <div class="stat-lbl">é€£ç¶šå­¦ç¿’</div>
      </div>
      <div class="stat-box" style="border-color:rgba(64,200,240,0.3); background:rgba(64,200,240,0.05);">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-val" id="statAvg" style="color:var(--accent3);">0<span style="font-size:0.6rem">åˆ†</span></div>
        <div class="stat-lbl">ï¼‘æ—¥å¹³å‡</div>
      </div>
    </div>
  </div>

  <!-- Timer Card -->
  <div class="timer-card">
    <h2>â± ã‚¿ã‚¤ãƒãƒ¼</h2>
    <div class="subject-select" id="subjectSelect">
      <button class="subject-btn active" data-subject="ç®—æ•°" data-color="#f0c040">ğŸ“ ç®—æ•°</button>
      <button class="subject-btn" data-subject="è‹±èª" data-color="#40c8f0">ğŸ“– è‹±èª</button>
      <button class="subject-btn" data-subject="ç†ç§‘" data-color="#5affa0">ğŸ”¬ ç†ç§‘</button>
      <button class="subject-btn" data-subject="å›½èª" data-color="#e05a8a">âœï¸ å›½èª</button>
      <button class="subject-btn" data-subject="ç¤¾ä¼š" data-color="#c87840">ğŸŒ ç¤¾ä¼š</button>
      <button class="subject-btn" data-subject="ãƒ”ã‚¢ãƒ" data-color="#c878e0">ğŸ¹ ãƒ”ã‚¢ãƒ</button>
    </div>

    <!-- Piano Practice Panel -->
    <div id="pianoPracticePanel" style="display:none; margin-bottom:20px;">
      <div style="background:rgba(200,120,224,0.08); border:1px solid rgba(200,120,224,0.3); border-radius:16px; padding:16px;">
        <div style="font-family:'Zen Maru Gothic',sans-serif; font-size:0.85rem; color:#c878e0; margin-bottom:12px; letter-spacing:0.08em;">ğŸµ ç·´ç¿’è¨­å®š</div>
        <div style="margin-bottom:10px;">
          <label style="font-size:0.72rem; color:var(--text-dim); display:block; margin-bottom:5px;">ç·´ç¿’æ›²</label>
          <input id="pianoSongInput" type="text" placeholder="ä¾‹: ãƒãƒƒãƒ ã‚¤ãƒ³ãƒ™ãƒ³ã‚·ãƒ§ãƒ³ No.1" style="width:100%; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:8px 12px; color:var(--text); font-family:'Noto Sans JP',sans-serif; font-size:0.82rem; outline:none;" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="flex:1;">
            <label style="font-size:0.72rem; color:var(--text-dim); display:block; margin-bottom:5px;">é›£æ˜“åº¦</label>
            <div style="display:flex; gap:6px;" id="difficultyBtns">
              <button class="diff-btn active" data-diff="åˆç´š" onclick="setDifficulty(this)" style="flex:1; padding:6px 4px; background:rgba(200,120,224,0.15); border:1px solid rgba(200,120,224,0.4); border-radius:8px; color:#c878e0; font-size:0.72rem; cursor:pointer; font-family:'Noto Sans JP',sans-serif;">åˆç´š</button>
              <button class="diff-btn" data-diff="ä¸­ç´š" onclick="setDifficulty(this)" style="flex:1; padding:6px 4px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text-dim); font-size:0.72rem; cursor:pointer; font-family:'Noto Sans JP',sans-serif;">ä¸­ç´š</button>
              <button class="diff-btn" data-diff="ä¸Šç´š" onclick="setDifficulty(this)" style="flex:1; padding:6px 4px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text-dim); font-size:0.72rem; cursor:pointer; font-family:'Noto Sans JP',sans-serif;">ä¸Šç´š</button>
            </div>
          </div>
          <div style="flex:1;">
            <label style="font-size:0.72rem; color:var(--text-dim); display:block; margin-bottom:5px;">XPå€ç‡</label>
            <div id="pianoXpRate" style="font-family:'Zen Maru Gothic',sans-serif; font-size:1.2rem; color:#c878e0; font-weight:700; text-align:center; padding:4px;">Ã—1.0</div>
          </div>
        </div>
        <div style="margin-top:10px;">
          <label style="font-size:0.72rem; color:var(--text-dim); display:block; margin-bottom:5px;">ç·´ç¿’ãƒ¡ãƒ¢</label>
          <textarea id="pianoMemoInput" placeholder="ä¾‹: å³æ‰‹ã ã‘ã§3å›ã€ä¸¡æ‰‹ã§2å›..." rows="2" style="width:100%; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:8px 12px; color:var(--text); font-family:'Noto Sans JP',sans-serif; font-size:0.78rem; outline:none; resize:none;"></textarea>
        </div>
      </div>
    </div>
    <div class="timer-display" id="timerDisplay">00:00</div>
    <div class="timer-sub" id="timerSub">ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦å­¦ç¿’ã‚’å§‹ã‚ã‚ˆã†ï¼</div>
    <div class="timer-controls">
      <button class="btn btn-start" id="startBtn" onclick="startTimer()">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="btn btn-stop" id="stopBtn" onclick="stopTimer()" style="display:none">â¸ ã‚¹ãƒˆãƒƒãƒ—</button>
      <button class="btn btn-reset" onclick="resetTimer()">â†º</button>
    </div>
  </div>

  <!-- Today's Log -->
  <div class="log-card">
    <h2>ğŸ“‹ ä»Šæ—¥ã®è¨˜éŒ²</h2>
    <div class="log-list" id="logList">
      <div class="empty-log">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‹‰å¼·ã‚’å§‹ã‚ã‚ˆã†ï¼</div>
    </div>
  </div>

  <!-- Achievements -->
  <div class="achievements-card">
    <h2>ğŸ† å®Ÿç¸¾</h2>
    <div class="ach-grid" id="achGrid"></div>
  </div>

  <!-- Minigames Card -->
  <div class="achievements-card" style="margin-top:16px;" id="minigamesCard">
    <h2>ğŸ® ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </h2>
    <div id="minigamesList"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Level Up Overlay -->
<div class="levelup-overlay" id="levelupOverlay">
  <div class="levelup-box">
    <div class="big-text">LEVEL UP!</div>
    <div class="level-num" id="newLevelNum">2</div>
    <div class="new-title" id="newLevelTitle">ç§°å·: ğŸŒ¿ è¦‹ç¿’ã„å­¦è€…</div>
    <div id="levelupUnlock" style="margin-bottom:16px; font-size:0.85rem; color:#40c8f0; display:none;">
      ğŸ® æ–°ã—ã„ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ãŒè§£æ”¾ã•ã‚ŒãŸï¼
    </div>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="closeLevelUp()" style="background:var(--surface); color:var(--text-dim); border:1px solid var(--border); border-radius:50px; padding:10px 22px; font-family:'Zen Maru Gothic',sans-serif; font-size:0.9rem; cursor:pointer;">ã¨ã˜ã‚‹</button>
      <button id="playMiniBtn" onclick="closeLevelUpAndPlay()" style="display:none; background:linear-gradient(135deg,#40c8f0,#4060f0); color:white; border:none; border-radius:50px; padding:10px 22px; font-family:'Zen Maru Gothic',sans-serif; font-size:0.9rem; font-weight:700; cursor:pointer;">ğŸ® ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§éŠã¶ï¼</button>
    </div>
  </div>
</div>

<!-- Minigame Overlay -->
<div id="minigameOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,6,15,0.97);z-index:500;display:none;overflow-y:auto;">
  <div style="max-width:480px;margin:0 auto;padding:20px 16px 40px;position:relative;">
    <button onclick="closeMinigame()" style="position:fixed;top:16px;right:16px;background:rgba(255,255,255,0.1);border:1px solid var(--border);color:var(--text);border-radius:50%;width:40px;height:40px;font-size:1.1rem;cursor:pointer;z-index:10;">âœ•</button>
    <div id="minigameContent"></div>
  </div>
</div>

<script>
// =================== DATA ===================
const LEVELS = [
  { lv: 1,  xpNeeded: 60,   title: 'ğŸŒ± è¦‹ç¿’ã„å†’é™ºè€…',  color: '#78a860' },
  { lv: 2,  xpNeeded: 120,  title: 'ğŸ“š åˆç´šå­¦è€…',       color: '#60a8c8' },
  { lv: 3,  xpNeeded: 200,  title: 'âš¡ åŠªåŠ›ã®æˆ¦å£«',     color: '#c8a040' },
  { lv: 4,  xpNeeded: 300,  title: 'ğŸ”¥ çŸ¥è­˜ã®æ¢æ±‚è€…',   color: '#e06840' },
  { lv: 5,  xpNeeded: 450,  title: 'ğŸŒŸ è¼ã‘ã‚‹å­¦å¾’',     color: '#a860d8' },
  { lv: 6,  xpNeeded: 650,  title: 'âš”ï¸ å‹‡è€…ã®åµ',       color: '#4088e0' },
  { lv: 7,  xpNeeded: 900,  title: 'ğŸ¦‹ è¦šé†’ã®ç”³ã—å­',   color: '#e05898' },
  { lv: 8,  xpNeeded: 1200, title: 'ğŸŒ™ æœˆã®è³¢è€…',       color: '#8848c8' },
  { lv: 9,  xpNeeded: 1600, title: 'ğŸŒˆ ä¼èª¬ã®å­¦è€…',     color: '#f09840' },
  { lv: 10, xpNeeded: 9999, title: 'ğŸ‘‘ å‹‰å¼·ã®è¦‡è€…',     color: '#f0c040' },
];

const ACHIEVEMENTS = [
  { id: 'first5',    icon: 'ğŸ¯', name: 'æœ€åˆã®ä¸€æ­©',      cond: s => s.totalMin >= 5 },
  { id: 'first30',   icon: 'ğŸŒŸ', name: '30åˆ†é”æˆ',         cond: s => s.totalMin >= 30 },
  { id: 'first60',   icon: 'â°', name: '1æ™‚é–“ã®å£',        cond: s => s.totalMin >= 60 },
  { id: 'first300',  icon: 'ğŸ’ª', name: '5æ™‚é–“çªç ´',        cond: s => s.totalMin >= 300 },
  { id: 'streak3',   icon: 'ğŸ”¥', name: '3æ—¥é€£ç¶š',          cond: s => s.streak >= 3 },
  { id: 'streak7',   icon: 'ğŸ’', name: 'ä¸€é€±é–“é€£ç¶š',       cond: s => s.streak >= 7 },
  { id: 'lv3',       icon: 'ğŸš€', name: 'Lv.3åˆ°é”',         cond: s => s.level >= 3 },
  { id: 'lv5',       icon: 'ğŸ†', name: 'Lv.5åˆ°é”',         cond: s => s.level >= 5 },
  { id: 'piano1',    icon: 'ğŸ¹', name: 'ãƒ”ã‚¢ãƒå…¥é–€',       cond: s => (s.pianoMin || 0) >= 10 },
  { id: 'piano2',    icon: 'ğŸµ', name: 'ãƒ¡ãƒ­ãƒ‡ã‚£ã‚¹ãƒˆ',     cond: s => (s.pianoMin || 0) >= 60 },
  { id: 'piano3',    icon: 'ğŸ¶', name: 'ãƒ”ã‚¢ãƒåæ‰‹',       cond: s => (s.pianoMin || 0) >= 300 },
  { id: 'pianoAdv',  icon: 'ğŸ‘‘', name: 'ä¸Šç´šæ›²ã‚’ã‚¯ãƒªã‚¢',   cond: s => (s.pianoAdvCount || 0) >= 1 },
];

const SUBJECT_COLORS = {
  'ç®—æ•°': '#f0c040', 'è‹±èª': '#40c8f0', 'ç†ç§‘': '#5affa0',
  'å›½èª': '#e05a8a', 'ç¤¾ä¼š': '#c87840', 'ãƒ”ã‚¢ãƒ': '#c878e0',
};

var PIANO_XP_RATE = { 'åˆç´š': 1.0, 'ä¸­ç´š': 1.5, 'ä¸Šç´š': 2.0 };
var selectedDifficulty = 'åˆç´š';
var pianoSongHistory = JSON.parse(localStorage.getItem('pianoSongs') || '[]');

// =================== SAVE/LOAD ===================
function saveState() {
  localStorage.setItem('studyquest', JSON.stringify(state));
}

// =================== STATE ===================
var savedState = localStorage.getItem('studyquest');
var state = savedState ? JSON.parse(savedState) : {
  totalMin: 0, todayMin: 0, streak: 1, xp: 0, level: 1,
  logs: [], unlockedAch: [], lastDate: new Date().toDateString(),
  dailyLog: {}
};

// Check if day changed
if (state.lastDate !== new Date().toDateString()) {
  if (!state.dailyLog) { state.dailyLog = {}; }
  if (state.todayMin > 0) {
    state.dailyLog[state.lastDate] = (state.dailyLog[state.lastDate] || 0) + state.todayMin;
  }
  state.todayMin = 0;
  state.lastDate = new Date().toDateString();
  saveState();
}
if (!state.dailyLog) { state.dailyLog = {}; }

var timerInterval = null;
var timerSeconds = 0;
var isRunning = false;
var selectedSubject = 'ç®—æ•°';


// =================== UI RENDER ===================
function render() {
  const lvData = LEVELS[Math.min(state.level - 1, LEVELS.length - 1)];
  const nextLvData = LEVELS[Math.min(state.level, LEVELS.length - 1)];

  // Show correct character stage
  const stage = Math.min(Math.ceil(state.level / 3), 4);
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('charStage' + i);
    if (el) el.style.display = (i === stage) ? 'block' : 'none';
  }
  document.getElementById('charName').textContent = 'ã¾ãªã³ã‚“';
  document.getElementById('charTitle').textContent = lvData.title;
  document.getElementById('levelNum').textContent = state.level;

  const xpForThisLevel = state.xp - (state.level > 1 ? LEVELS[state.level - 2].xpNeeded : 0);
  const xpNeeded = lvData.xpNeeded - (state.level > 1 ? LEVELS[state.level - 2].xpNeeded : 0);
  const pct = Math.min(100, (xpForThisLevel / xpNeeded) * 100);

  document.getElementById('xpText').textContent = `${state.xp} / ${lvData.xpNeeded} XP`;
  document.getElementById('xpBar').style.width = pct + '%';

  document.getElementById('statTotal').innerHTML = `${state.totalMin}<span style="font-size:0.6rem">åˆ†</span>`;
  document.getElementById('statStreak').innerHTML = `${state.streak}<span style="font-size:0.6rem">æ—¥</span>`;
  document.getElementById('statToday').innerHTML = `${state.todayMin}<span style="font-size:0.6rem">åˆ†</span>`;

  // Calculate daily average (include today if studied)
  var dl = state.dailyLog || {};
  var allDays = [];
  for (var dk in dl) { if (dl.hasOwnProperty(dk)) { allDays.push(dl[dk]); } }
  if (state.todayMin > 0 && !dl[new Date().toDateString()]) { allDays.push(state.todayMin); }
  var avg = allDays.length > 0 ? Math.round(allDays.reduce(function(a,b){return a+b;},0) / allDays.length) : 0;
  document.getElementById('statAvg').innerHTML = `${avg}<span style="font-size:0.6rem">åˆ†</span>`;

  renderLogs();
  renderAchievements();
  renderMinigamesList();
}

function renderLogs() {
  const list = document.getElementById('logList');
  const todayLogs = state.logs.filter(l => l.date === new Date().toDateString()).slice(-6).reverse();
  if (todayLogs.length === 0) {
    list.innerHTML = '<div class="empty-log">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‹‰å¼·ã‚’å§‹ã‚ã‚ˆã†ï¼</div>';
    return;
  }
  list.innerHTML = todayLogs.map(l => {
    const pianoExtra = l.subject === 'ãƒ”ã‚¢ãƒ' && (l.song || l.difficulty)
      ? `<div style="font-size:0.68rem; color:#c878e0; margin-top:2px;">${l.song ? `ğŸµ ${l.song}` : ''} ${l.difficulty ? `[${l.difficulty}]` : ''}</div>`
      : '';
    return `
      <div class="log-item" style="flex-wrap:wrap;">
        <div class="log-dot" style="background:${SUBJECT_COLORS[l.subject] || '#aaa'}"></div>
        <div class="log-subject" style="flex:1;">${l.subject}${pianoExtra}</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="log-time">${l.minutes}åˆ†</div>
          <div class="log-xp">+${l.xpGained} XP</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderAchievements() {
  const grid = document.getElementById('achGrid');
  grid.innerHTML = ACHIEVEMENTS.map(a => `
    <div class="ach-item ${state.unlockedAch.includes(a.id) ? 'unlocked' : ''}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}</div>
    </div>
  `).join('');
}

// =================== TIMER ===================
function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function startTimer() {
  if (isRunning) return;
  isRunning = true;
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'inline-block';
  document.getElementById('timerDisplay').classList.add('running');
  document.getElementById('timerSub').textContent = selectedSubject === 'ãƒ”ã‚¢ãƒ'
    ? `ğŸ¹ ãƒ”ã‚¢ãƒç·´ç¿’ä¸­... [${selectedDifficulty}]`
    : `${selectedSubject}ã‚’å‹‰å¼·ä¸­...`;

  timerInterval = setInterval(() => {
    timerSeconds++;
    document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);

    // XP every 5 minutes
    if (timerSeconds % 300 === 0) {
      addStudySession(5);
    }
  }, 1000);
}

function stopTimer() {
  if (!isRunning) return;
  clearInterval(timerInterval);
  isRunning = false;

  document.getElementById('startBtn').style.display = 'inline-block';
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('timerDisplay').classList.remove('running');
  document.getElementById('timerSub').textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦å­¦ç¿’ã‚’å§‹ã‚ã‚ˆã†ï¼';

  const mins = Math.floor(timerSeconds / 60);
  if (mins >= 1) {
    addStudySession(mins, true);
    timerSeconds = timerSeconds % 60;
    document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
  } else {
    showToast('âš ï¸ 1åˆ†ä»¥ä¸Šã§è¨˜éŒ²ã•ã‚Œã¾ã™');
  }
}

function resetTimer() {
  if (isRunning) stopTimer();
  timerSeconds = 0;
  document.getElementById('timerDisplay').textContent = '00:00';
}

function addStudySession(minutes, isManual) {
  if (isManual === undefined) { isManual = false; }
  const isPiano = selectedSubject === 'ãƒ”ã‚¢ãƒ';
  const rate = isPiano ? PIANO_XP_RATE[selectedDifficulty] : 1.0;
  const xpGained = Math.round(minutes * 2 * rate);
  state.totalMin += minutes;
  state.todayMin += minutes;

  // Track daily log for average calculation
  const today = new Date().toDateString();
  if (!state.dailyLog) state.dailyLog = {};
  state.dailyLog[today] = (state.dailyLog[today] || 0) + minutes;

  if (isPiano) {
    state.pianoMin = (state.pianoMin || 0) + minutes;
    if (selectedDifficulty === 'ä¸Šç´š') {
      state.pianoAdvCount = (state.pianoAdvCount || 0) + (isManual ? 1 : 0);
    }
  }

  // XP & Level
  const oldLevel = state.level;
  state.xp += xpGained;

  // Check level up
  while (state.level < LEVELS.length && state.xp >= LEVELS[state.level - 1].xpNeeded) {
    state.level++;
  }

  // Log
  if (isManual) {
    const songName = isPiano ? (document.getElementById('pianoSongInput').value.trim() || '') : '';
    const memo = isPiano ? (document.getElementById('pianoMemoInput').value.trim() || '') : '';
    var entry = {
      subject: selectedSubject,
      minutes: minutes,
      xpGained: xpGained,
      date: new Date().toDateString()
    };
    if (isPiano) {
      entry.song = songName;
      entry.difficulty = selectedDifficulty;
      entry.memo = memo;
    }
    state.logs.push(entry);

    if (isPiano && songName && !pianoSongHistory.includes(songName)) {
      pianoSongHistory.unshift(songName);
      if (pianoSongHistory.length > 20) pianoSongHistory.pop();
      localStorage.setItem('pianoSongs', JSON.stringify(pianoSongHistory));
    }

    const rateLabel = rate > 1 ? ` (Ã—${rate} ãƒœãƒ¼ãƒŠã‚¹ï¼)` : '';
    showToast(`ğŸµ ${minutes}åˆ†ç·´ç¿’ï¼ +${xpGained} XP${rateLabel}`);
  }

  // Check achievements
  checkAchievements();

  if (state.level > oldLevel) {
    setTimeout(() => showLevelUp(state.level), 600);
  }

  saveState();
  render();
}

// =================== MINIGAME DEFINITIONS ===================
const MINIGAMES = [
  { id: 'quiz',   unlockLv: 2, icon: 'ğŸ§®', name: 'ç®—æ•°ã‚¯ã‚¤ã‚º',    desc: 'è¨ˆç®—å•é¡Œã«æŒ‘æˆ¦ï¼æ­£è§£ã§ãƒœãƒ¼ãƒŠã‚¹XP' },
  { id: 'memory', unlockLv: 4, icon: 'ğŸƒ', name: 'è¨˜æ†¶ã‚«ãƒ¼ãƒ‰',     desc: 'çµµåˆã‚ã›ã‚«ãƒ¼ãƒ‰ã‚’å…¨éƒ¨ã‚ãã‚ã†' },
  { id: 'rhythm', unlockLv: 6, icon: 'ğŸ¥', name: 'ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ',   desc: 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚ˆãã‚¿ãƒƒãƒ—ï¼' },
];

function getUnlockedGames() {
  return MINIGAMES.filter(g => state.level >= g.unlockLv);
}

function renderMinigamesList() {
  const el = document.getElementById('minigamesList');
  const unlocked = getUnlockedGames();
  if (unlocked.length === 0) {
    el.innerHTML = `<div style="text-align:center;color:var(--text-dim);font-size:0.8rem;padding:14px;">ãƒ¬ãƒ™ãƒ«2ã«ãªã‚‹ã¨ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ãŒè§£æ”¾ã•ã‚Œã¾ã™ï¼</div>`;
    return;
  }
  el.innerHTML = unlocked.map(g => `
    <div onclick="openMinigame('${g.id}')" style="display:flex;align-items:center;gap:14px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#40c8f0'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="font-size:2rem;width:40px;text-align:center;">${g.icon}</div>
      <div style="flex:1;">
        <div style="font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:0.95rem;">${g.name}</div>
        <div style="font-size:0.72rem;color:var(--text-dim);margin-top:2px;">${g.desc}</div>
      </div>
      <div style="color:#40c8f0;font-size:1.2rem;">â–¶</div>
    </div>
  `).join('') + MINIGAMES.filter(g => state.level < g.unlockLv).map(g => `
    <div style="display:flex;align-items:center;gap:14px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;opacity:0.4;">
      <div style="font-size:2rem;width:40px;text-align:center;filter:grayscale(1);">${g.icon}</div>
      <div style="flex:1;">
        <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:0.95rem;">${g.name}</div>
        <div style="font-size:0.72rem;color:var(--text-dim);">ğŸ”’ Lv.${g.unlockLv}ã§è§£æ”¾</div>
      </div>
    </div>
  `).join('');
}

// =================== LEVEL UP ===================
function showLevelUp(level) {
  const lvData = LEVELS[Math.min(level - 1, LEVELS.length - 1)];
  document.getElementById('newLevelNum').textContent = level;
  document.getElementById('newLevelTitle').textContent = `ç§°å·: ${lvData.title}`;

  // Check if new game just unlocked
  const newGame = MINIGAMES.find(g => g.unlockLv === level);
  const unlockEl = document.getElementById('levelupUnlock');
  const playBtn = document.getElementById('playMiniBtn');
  if (newGame) {
    unlockEl.textContent = `ğŸ®ã€Œ${newGame.icon} ${newGame.name}ã€ãŒè§£æ”¾ã•ã‚ŒãŸï¼`;
    unlockEl.style.display = 'block';
    playBtn.style.display = 'inline-block';
    playBtn.dataset.game = newGame.id;
  } else {
    unlockEl.style.display = 'none';
    playBtn.style.display = 'none';
  }

  document.getElementById('levelupOverlay').classList.add('show');
  spawnConfetti();
}

function closeLevelUp() {
  document.getElementById('levelupOverlay').classList.remove('show');
  renderMinigamesList();
}

let pendingGame = null;
function closeLevelUpAndPlay() {
  const game = document.getElementById('playMiniBtn').dataset.game;
  closeLevelUp();
  setTimeout(() => openMinigame(game), 300);
}

// =================== MINIGAME ENGINE ===================
function openMinigame(id) {
  const overlay = document.getElementById('minigameOverlay');
  overlay.style.display = 'block';
  const content = document.getElementById('minigameContent');
  if (id === 'quiz') renderQuizGame(content);
  else if (id === 'memory') renderMemoryGame(content);
  else if (id === 'rhythm') renderRhythmGame(content);
}

function closeMinigame() {
  document.getElementById('minigameOverlay').style.display = 'none';
  // stop any intervals
  if (window._rhythmInterval) { clearInterval(window._rhythmInterval); window._rhythmInterval = null; }
}

function gameHeader(icon, name) {
  return `<div style="text-align:center;margin-bottom:24px;padding-top:8px;">
    <div style="font-size:3rem;">${icon}</div>
    <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:1.4rem;font-weight:900;margin-top:6px;">${name}</div>
  </div>`;
}

function giveGameXP(xp, label) {
  state.xp += xp;
  const oldLevel = state.level;
  while (state.level < LEVELS.length && state.xp >= LEVELS[state.level - 1].xpNeeded) state.level++;
  if (state.level > oldLevel) setTimeout(() => showLevelUp(state.level), 800);
  saveState();
  render();
  showToast(`ğŸ® ${label}ï¼ +${xp} XP`);
}

// =================== QUIZ GAME ===================
function renderQuizGame(el) {
  const questions = generateQuizQuestions();
  let qi = 0, score = 0, answered = false;

  function draw() {
    if (qi >= questions.length) {
      const bonus = score * 5;
      giveGameXP(bonus, `ã‚¯ã‚¤ã‚º ${score}/${questions.length}å•æ­£è§£`);
      el.innerHTML = gameHeader('ğŸ§®','ç®—æ•°ã‚¯ã‚¤ã‚º') + `
        <div style="text-align:center;background:var(--card);border-radius:20px;padding:32px 24px;">
          <div style="font-size:3rem;margin-bottom:12px;">${score >= 4 ? 'ğŸŒŸ' : score >= 2 ? 'ğŸ‘' : 'ğŸ˜…'}</div>
          <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:1.8rem;font-weight:900;color:var(--accent);">${score} / ${questions.length}</div>
          <div style="color:var(--text-dim);margin:8px 0 20px;">ç²å¾—XP: +${bonus}</div>
          <button onclick="renderQuizGame(document.getElementById('minigameContent'))" style="background:linear-gradient(135deg,var(--accent),#f0a020);color:#0d0f1a;border:none;border-radius:50px;padding:12px 28px;font-family:'Zen Maru Gothic',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;margin-right:8px;">ã‚‚ã†ä¸€åº¦</button>
          <button onclick="closeMinigame()" style="background:var(--surface);color:var(--text-dim);border:1px solid var(--border);border-radius:50px;padding:12px 24px;font-family:'Zen Maru Gothic',sans-serif;font-size:0.95rem;cursor:pointer;">ãŠã‚ã‚‹</button>
        </div>`;
      return;
    }
    const q = questions[qi];
    el.innerHTML = gameHeader('ğŸ§®','ç®—æ•°ã‚¯ã‚¤ã‚º') + `
      <div style="text-align:center;margin-bottom:8px;color:var(--text-dim);font-size:0.8rem;">${qi+1} / ${questions.length}å•</div>
      <div style="background:var(--card);border-radius:20px;padding:28px 20px;margin-bottom:16px;text-align:center;">
        <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:2.2rem;font-weight:900;margin-bottom:8px;">${q.question}</div>
        <div style="font-size:0.8rem;color:var(--text-dim);">= ?</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;" id="quizOpts">
        ${q.options.map((opt,i) => `
          <button onclick="quizAnswer(${i},${q.correct},${q.options[opt]})" style="background:var(--card);border:2px solid var(--border);border-radius:16px;padding:18px;font-family:'Zen Maru Gothic',sans-serif;font-size:1.4rem;font-weight:700;color:var(--text);cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent3)'" onmouseout="this.style.borderColor='var(--border)'">${opt}</button>
        `).join('')}
      </div>
      <div id="quizFeedback" style="text-align:center;margin-top:16px;min-height:40px;"></div>`;
  }

  window.quizAnswer = function(idx, correctIdx, val) {
    if (answered) return;
    answered = true;
    const btns = document.querySelectorAll('#quizOpts button');
    const q = questions[qi];
    const isCorrect = idx === correctIdx;
    btns.forEach((b,i) => {
      if (i === correctIdx) b.style.borderColor = '#5affa0', b.style.background = 'rgba(90,255,160,0.15)';
      else if (i === idx && !isCorrect) b.style.borderColor = '#e05a8a', b.style.background = 'rgba(224,90,138,0.15)';
    });
    if (isCorrect) score++;
    document.getElementById('quizFeedback').innerHTML = `<span style="font-size:1.5rem;">${isCorrect ? 'â­• æ­£è§£ï¼' : `âŒ ç­”ãˆã¯ ${q.answer}`}</span>`;
    setTimeout(() => { qi++; answered = false; draw(); }, 1200);
  };

  draw();
}

function generateQuizQuestions() {
  const qs = [];
  const types = ['add','sub','mul','div'];
  for (let i = 0; i < 5; i++) {
    const type = types[Math.floor(Math.random() * types.length)];
    let a, b, answer, question;
    if (type === 'add') { a = rn(10,50); b = rn(10,50); answer = a+b; question = `${a} + ${b}`; }
    else if (type === 'sub') { a = rn(20,80); b = rn(5,a-1); answer = a-b; question = `${a} - ${b}`; }
    else if (type === 'mul') { a = rn(2,12); b = rn(2,12); answer = a*b; question = `${a} Ã— ${b}`; }
    else { a = rn(2,9); b = rn(2,9); answer = a; question = `${a*b} Ã· ${b}`; }
    const opts = shuffle([answer, answer+rn(1,5), answer-rn(1,4), answer+rn(6,12)].filter((v,i,a)=>a.indexOf(v)===i&&v>0)).slice(0,4);
    const correct = opts.indexOf(answer);
    qs.push({ question, answer, options: opts, correct });
  }
  return qs;
}

// =================== MEMORY GAME ===================
function renderMemoryGame(el) {
  const emojis = ['ğŸŒŸ','ğŸ¯','ğŸ”¥','ğŸ’','ğŸš€','ğŸµ','ğŸŒˆ','âš¡'];
  var cards = shuffle(emojis.concat(emojis)).map(function(e,i) { return {id:i, emoji:e, flipped:false, matched:false}; });
  let selected = [], moves = 0, locked = false;

  function draw() {
    const matched = cards.filter(c=>c.matched).length / 2;
    el.innerHTML = gameHeader('ğŸƒ','è¨˜æ†¶ã‚«ãƒ¼ãƒ‰') + `
      <div style="display:flex;justify-content:space-between;margin-bottom:14px;font-size:0.82rem;color:var(--text-dim);">
        <span>ãƒšã‚¢: <b style="color:var(--xp-color)">${matched}/8</b></span>
        <span>æ‰‹æ•°: <b style="color:var(--accent)">${moves}</b></span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;" id="memGrid">
        ${cards.map(c => `
          <div onclick="memFlip(${c.id})" style="aspect-ratio:1;background:${c.matched?'rgba(90,255,160,0.15)':c.flipped?'var(--card)':'var(--surface)'};border:2px solid ${c.matched?'#5affa0':c.flipped?'var(--accent3)':'var(--border)'};border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;transition:all 0.2s;${c.matched?'pointer-events:none':''}">
            ${c.flipped||c.matched ? c.emoji : ''}
          </div>
        `).join('')}
      </div>`;
  }

  window.memFlip = function(id) {
    if (locked) return;
    const card = cards.find(c=>c.id===id);
    if (!card || card.flipped || card.matched) return;
    card.flipped = true;
    selected.push(card);
    draw();
    if (selected.length === 2) {
      moves++;
      locked = true;
      if (selected[0].emoji === selected[1].emoji) {
        selected.forEach(c=>c.matched=true);
        selected = []; locked = false;
        draw();
        if (cards.every(c=>c.matched)) {
          const bonus = Math.max(10, 40 - moves);
          giveGameXP(bonus, `è¨˜æ†¶ã‚«ãƒ¼ãƒ‰ ${moves}æ‰‹ã§ã‚¯ãƒªã‚¢`);
          setTimeout(() => {
            el.innerHTML = gameHeader('ğŸƒ','è¨˜æ†¶ã‚«ãƒ¼ãƒ‰') + `
              <div style="text-align:center;background:var(--card);border-radius:20px;padding:32px 24px;">
                <div style="font-size:3rem;">${moves<=12?'ğŸŒŸ':moves<=18?'ğŸ‘':'ğŸ˜…'}</div>
                <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:1.4rem;font-weight:900;color:var(--accent);margin:10px 0;">${moves}æ‰‹ã§ã‚¯ãƒªã‚¢ï¼</div>
                <div style="color:var(--text-dim);margin-bottom:20px;">ç²å¾—XP: +${bonus}</div>
                <button onclick="renderMemoryGame(document.getElementById('minigameContent'))" style="background:linear-gradient(135deg,var(--accent),#f0a020);color:#0d0f1a;border:none;border-radius:50px;padding:12px 28px;font-family:'Zen Maru Gothic',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;margin-right:8px;">ã‚‚ã†ä¸€åº¦</button>
                <button onclick="closeMinigame()" style="background:var(--surface);color:var(--text-dim);border:1px solid var(--border);border-radius:50px;padding:12px 24px;font-family:'Zen Maru Gothic',sans-serif;cursor:pointer;">ãŠã‚ã‚‹</button>
              </div>`;
          }, 500);
        }
      } else {
        setTimeout(() => {
          selected.forEach(c=>c.flipped=false);
          selected=[]; locked=false;
          draw();
        }, 900);
      }
    }
  };
  draw();
}

// =================== RHYTHM GAME ===================
function renderRhythmGame(el) {
  const COLS = 4;
  const COL_COLORS = ['#f0c040','#e05a8a','#40c8f0','#5affa0'];
  const COL_KEYS = ['â¬›','â¬›','â¬›','â¬›'];
  let score = 0, miss = 0, notes = [], frame = 0, active = true;
  const MAX_MISS = 5, GAME_DURATION = 30;
  let timeLeft = GAME_DURATION;

  el.innerHTML = gameHeader('ğŸ¥','ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ') + `
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:0.82rem;">
      <span style="color:var(--xp-color)">ã‚¹ã‚³ã‚¢: <b id="rScore">0</b></span>
      <span style="color:var(--accent)">â± <b id="rTime">30</b>s</span>
      <span style="color:#e05a8a">ãƒŸã‚¹: <b id="rMiss">0</b>/${MAX_MISS}</span>
    </div>
    <div id="rTrack" style="background:var(--surface);border-radius:16px;height:320px;position:relative;overflow:hidden;border:1px solid var(--border);">
      <div style="position:absolute;bottom:72px;left:0;right:0;height:2px;background:rgba(255,255,255,0.15);"></div>
      <div id="rNotes" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px;" id="rBtns">
      ${COL_COLORS.map((c,i) => `
        <button onpointerdown="rhythmTap(${i})" id="rBtn${i}" style="background:${c}22;border:2px solid ${c}66;border-radius:14px;padding:18px 0;font-size:1.4rem;cursor:pointer;transition:all 0.1s;color:${c};">â–¼</button>
      `).join('')}
    </div>
    <div style="text-align:center;margin-top:10px;font-size:0.72rem;color:var(--text-dim);">ãƒãƒ¼ãƒ„ãŒä¸‹ã®ãƒ©ã‚¤ãƒ³ã«æ¥ãŸã‚‰ã‚¿ãƒƒãƒ—ï¼</div>`;

  const notesEl = document.getElementById('rNotes');
  const trackEl = document.getElementById('rTrack');
  const HIT_Y = 248; // px from top

  function spawnNote() {
    const col = Math.floor(Math.random() * COLS);
    const colW = trackEl.offsetWidth / COLS;
    const n = { col, y: -20, id: frame, hit: false };
    notes.push(n);
    const div = document.createElement('div');
    div.id = 'n' + n.id;
    div.style.cssText = `position:absolute;width:${colW-12}px;height:32px;background:${COL_COLORS[col]};border-radius:10px;left:${col*colW+6}px;top:-32px;box-shadow:0 0 10px ${COL_COLORS[col]}88;`;
    notesEl.appendChild(div);
  }

  const speed = 4;
  let lastSpawn = 0;
  let timerCountdown = setInterval(() => {
    if (!active) return;
    timeLeft--;
    const el2 = document.getElementById('rTime');
    if (el2) el2.textContent = timeLeft;
    if (timeLeft <= 0) endRhythm();
  }, 1000);

  function loop() {
    if (!active) return;
    frame++;
    if (frame - lastSpawn > 30 + Math.floor(Math.random() * 30)) {
      spawnNote();
      lastSpawn = frame;
    }
    const colW = trackEl.offsetWidth / COLS;
    notes.forEach(n => {
      if (n.hit) return;
      n.y += speed;
      const div = document.getElementById('n'+n.id);
      if (div) div.style.top = n.y + 'px';
      if (n.y > HIT_Y + 40 && !n.hit) {
        n.hit = true;
        miss++;
        if (div) { div.style.opacity = '0.2'; setTimeout(()=>div.remove(),300); }
        const mEl = document.getElementById('rMiss');
        if (mEl) mEl.textContent = miss;
        if (miss >= MAX_MISS) endRhythm();
      }
    });
    notes = notes.filter(n => document.getElementById('n'+n.id));
    window._rhythmInterval = requestAnimationFrame(loop);
  }

  window.rhythmTap = function(col) {
    const btn = document.getElementById('rBtn'+col);
    if (btn) { btn.style.background = COL_COLORS[col]+'55'; setTimeout(()=>btn.style.background=COL_COLORS[col]+'22',150); }
    const hit = notes.find(n => n.col===col && !n.hit && n.y > HIT_Y-50 && n.y < HIT_Y+50);
    if (hit) {
      hit.hit = true;
      score++;
      const div = document.getElementById('n'+hit.id);
      if (div) { div.style.background='white'; div.style.transform='scale(1.3)'; setTimeout(()=>div.remove(),200); }
      const sEl = document.getElementById('rScore');
      if (sEl) sEl.textContent = score;
      // show GOOD
      showHitLabel(hit.col, 'âœ¨ GOOD');
    }
  };

  function showHitLabel(col, text) {
    const colW = (trackEl.offsetWidth || 300) / COLS;
    const d = document.createElement('div');
    d.textContent = text;
    d.style.cssText = `position:absolute;left:${col*colW+colW/2}px;top:${HIT_Y-20}px;transform:translateX(-50%);font-family:'Zen Maru Gothic',sans-serif;font-size:0.85rem;font-weight:700;color:white;pointer-events:none;animation:floatUp 0.6s forwards;`;
    notesEl.appendChild(d);
    setTimeout(()=>d.remove(),600);
  }

  function endRhythm() {
    active = false;
    clearInterval(timerCountdown);
    if (window._rhythmInterval) { cancelAnimationFrame(window._rhythmInterval); window._rhythmInterval = null; }
    const bonus = score * 3;
    giveGameXP(bonus, `ãƒªã‚ºãƒ  ${score}ãƒãƒ¼ãƒ„ãƒ’ãƒƒãƒˆ`);
    setTimeout(() => {
      el.innerHTML = gameHeader('ğŸ¥','ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ') + `
        <div style="text-align:center;background:var(--card);border-radius:20px;padding:32px 24px;">
          <div style="font-size:3rem;">${score>=20?'ğŸŒŸ':score>=10?'ğŸ‘':'ğŸ˜…'}</div>
          <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:1.8rem;font-weight:900;color:var(--accent);margin:10px 0;">ã‚¹ã‚³ã‚¢: ${score}</div>
          <div style="color:var(--text-dim);margin-bottom:20px;">ç²å¾—XP: +${bonus}</div>
          <button onclick="renderRhythmGame(document.getElementById('minigameContent'))" style="background:linear-gradient(135deg,var(--accent),#f0a020);color:#0d0f1a;border:none;border-radius:50px;padding:12px 28px;font-family:'Zen Maru Gothic',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;margin-right:8px;">ã‚‚ã†ä¸€åº¦</button>
          <button onclick="closeMinigame()" style="background:var(--surface);color:var(--text-dim);border:1px solid var(--border);border-radius:50px;padding:12px 24px;font-family:'Zen Maru Gothic',sans-serif;cursor:pointer;">ãŠã‚ã‚‹</button>
        </div>`;
    }, 500);
  }

  window._rhythmInterval = requestAnimationFrame(loop);
}

// =================== UTILS ===================
function rn(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
function shuffle(arr) { for (let i=arr.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }



function spawnConfetti() {
  const colors = ['#f0c040', '#e05a8a', '#40c8f0', '#5affa0', '#c880f0'];
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + 'vw';
    p.style.top = '-10px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    p.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 4000);
  }
}

// =================== TOAST ===================
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}

// =================== ACHIEVEMENTS ===================
function checkAchievements() {
  ACHIEVEMENTS.forEach(a => {
    if (!state.unlockedAch.includes(a.id) && a.cond(state)) {
      state.unlockedAch.push(a.id);
      setTimeout(() => showToast(`ğŸ† å®Ÿç¸¾è§£é™¤ï¼ã€Œ${a.name}ã€ ${a.icon}`), 1200);
    }
  });
}

// =================== SUBJECT SELECT ===================
document.querySelectorAll('.subject-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedSubject = btn.dataset.subject;
    const pianoPanel = document.getElementById('pianoPracticePanel');
    pianoPanel.style.display = selectedSubject === 'ãƒ”ã‚¢ãƒ' ? 'block' : 'none';
    if (selectedSubject === 'ãƒ”ã‚¢ãƒ') {
      document.getElementById('timerSub').textContent = 'ãƒ”ã‚¢ãƒç·´ç¿’ã®è¨­å®šã‚’ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
    }
  });
});

// =================== PIANO DIFFICULTY ===================
function setDifficulty(btn) {
  document.querySelectorAll('.diff-btn').forEach(b => {
    b.style.background = 'var(--surface)';
    b.style.borderColor = 'var(--border)';
    b.style.color = 'var(--text-dim)';
  });
  btn.style.background = 'rgba(200,120,224,0.15)';
  btn.style.borderColor = 'rgba(200,120,224,0.4)';
  btn.style.color = '#c878e0';
  selectedDifficulty = btn.dataset.diff;
  const rate = PIANO_XP_RATE[selectedDifficulty];
  document.getElementById('pianoXpRate').textContent = `Ã—${rate.toFixed(1)}`;
}

// =================== INIT ===================
render();
</script>
</body>
</html>
